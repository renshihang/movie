{"version":3,"sources":["../../src/amap/index.ts"],"names":["mapdivCount","AMAP_API_KEY","AMAP_VERSION","AMAP_SCRIPT_ID","amapLoaded","pendingResolveQueue","LNGLAT_OFFSET_ZOOM_THRESHOLD","AMapService","TYPES","IGlobalConfigService","ILogService","MapConfig","ICoordinateSystemService","IEventEmitter","map","markerContainer","$mapContainer","viewport","cameraChangedCallback","handleCameraChanged","e","camera","fov","near","far","height","pitch","rotation","aspect","position","getCenter","lng","lat","syncWithMapCamera","bearing","cameraHeight","zoom","getZoom","center","offsetOrigin","x","y","coordinateSystemService","setCoordinateSystem","CoordinateSystem","P20_OFFSET","P20","mapContainer","getContainer","amap","getElementsByClassName","DOM","create","type","handler","MapServiceEvent","indexOf","eventEmitter","on","off","size","getSize","getWidth","getHeight","setZoom","getLng","getLat","getPitch","getRotation","amapBound","getBounds","toBounds","NE","getNorthEast","SW","getSouthWest","maxlng","minlng","zooms","get","setRotation","zoomIn","zoomOut","p","panTo","pixel","extent","setBounds","AMap","Bounds","setZoomAndCenter","style","setMapStyle","getMapStyle","lngLat","pixelToLngLat","Pixel","lnglat","lnglatToPixel","LngLat","getX","getY","ll","containerToLngLat","lngLatToContainer","config","id","minZoom","maxZoom","token","mapInstance","plugin","rest","Promise","resolve","resolveMap","setTimeout","creatAmapContainer","Map","mapStyle","viewMode","logger","warn","configService","getSceneWarninfo","loadAMapScript","join","then","length","forEach","r","window","push","Viewport","name","args","emit","once","destroy","initAMap","$jsapi","document","getElementById","head","removeChild","callback","MapTheme","$wrapper","$amapdiv","createElement","cssText","appendChild","src","reject","script","onload","onerror"],"mappings":"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","sourcesContent":["/**\n * AMapService\n */\nimport {\n  Bounds,\n  CoordinateSystem,\n  ICoordinateSystemService,\n  IGlobalConfigService,\n  ILngLat,\n  ILogService,\n  IMapConfig,\n  IMapService,\n  IPoint,\n  IViewport,\n  MapServiceEvent,\n  MapStyle,\n  TYPES,\n} from '@antv/l7-core';\nimport { DOM } from '@antv/l7-utils';\nimport { inject, injectable } from 'inversify';\nimport { IAMapEvent, IAMapInstance } from '../../typings/index';\nimport { MapTheme } from './theme';\nimport Viewport from './Viewport';\nlet mapdivCount = 0;\n\nconst AMAP_API_KEY: string = '15cd8a57710d40c9b7c0e3cc120f1200';\nconst AMAP_VERSION: string = '1.4.15';\n/**\n * 确保多个场景只引入一个高德地图脚本\n */\nconst AMAP_SCRIPT_ID: string = 'amap-script';\n/**\n * 高德地图脚本是否加载完毕\n */\nlet amapLoaded = false;\n/**\n * 高德地图脚本加载成功等待队列，成功之后依次触发\n */\nlet pendingResolveQueue: Array<() => void> = [];\nconst LNGLAT_OFFSET_ZOOM_THRESHOLD = 12; // 暂时关闭 fix 统一不同坐标系，不同底图的高度位置\n\n/**\n * AMapService\n */\n@injectable()\nexport default class AMapService\n  implements IMapService<AMap.Map & IAMapInstance> {\n  /**\n   * 原始地图实例\n   */\n  public map: AMap.Map & IAMapInstance;\n\n  @inject(TYPES.IGlobalConfigService)\n  private readonly configService: IGlobalConfigService;\n\n  @inject(TYPES.ILogService)\n  private readonly logger: ILogService;\n\n  @inject(TYPES.MapConfig)\n  private readonly config: Partial<IMapConfig>;\n\n  @inject(TYPES.ICoordinateSystemService)\n  private readonly coordinateSystemService: ICoordinateSystemService;\n\n  @inject(TYPES.IEventEmitter)\n  private eventEmitter: any;\n\n  private markerContainer: HTMLElement;\n  private $mapContainer: HTMLElement | null;\n\n  private viewport: Viewport;\n\n  private cameraChangedCallback: (viewport: IViewport) => void;\n\n  public addMarkerContainer(): void {\n    const mapContainer = this.map.getContainer();\n    if (mapContainer !== null) {\n      const amap = mapContainer.getElementsByClassName(\n        'amap-maps',\n      )[0] as HTMLElement;\n      this.markerContainer = DOM.create('div', 'l7-marker-container', amap);\n    }\n  }\n  public getMarkerContainer(): HTMLElement {\n    return this.markerContainer;\n  }\n\n  //  map event\n  public on(type: string, handler: (...args: any[]) => void): void {\n    if (MapServiceEvent.indexOf(type) !== -1) {\n      this.eventEmitter.on(type, handler);\n    } else {\n      this.map.on(type, handler);\n    }\n  }\n  public off(type: string, handler: (...args: any[]) => void): void {\n    if (MapServiceEvent.indexOf(type) !== -1) {\n      this.eventEmitter.off(type, handler);\n    } else {\n      this.map.off(type, handler);\n    }\n  }\n\n  public getContainer(): HTMLElement | null {\n    return this.map.getContainer();\n  }\n\n  public getSize(): [number, number] {\n    const size = this.map.getSize();\n    return [size.getWidth(), size.getHeight()];\n  }\n\n  public getType() {\n    return 'amap';\n  }\n  public getZoom(): number {\n    // 统一返回 Mapbox 缩放等级\n    return this.map.getZoom() - 1;\n  }\n\n  public setZoom(zoom: number): void {\n    return this.map.setZoom(zoom);\n  }\n\n  public getCenter(): ILngLat {\n    const center = this.map.getCenter();\n    return {\n      lng: center.getLng(),\n      lat: center.getLat(),\n    };\n  }\n\n  public getPitch(): number {\n    return this.map.getPitch();\n  }\n\n  public getRotation(): number {\n    // 统一返回逆时针旋转角度\n    return 360 - this.map.getRotation();\n  }\n\n  public getBounds(): Bounds {\n    // @ts-ignore\n    const amapBound = this.map.getBounds().toBounds();\n    const NE = amapBound.getNorthEast();\n    const SW = amapBound.getSouthWest();\n    const center = this.getCenter();\n    const maxlng =\n      center.lng > NE.getLng() || center.lng < SW.getLng()\n        ? 180 - NE.getLng()\n        : NE.getLng();\n    const minlng = center.lng < SW.getLng() ? SW.getLng() - 180 : SW.getLng();\n    // 兼容 Mapbox，统一返回西南、东北\n    return [\n      [minlng, SW.getLat()],\n      [maxlng, NE.getLat()],\n    ];\n  }\n\n  public getMinZoom(): number {\n    const zooms = this.map.get('zooms') as [number, number];\n    return zooms[0] - 1;\n  }\n  public getMaxZoom(): number {\n    const zooms = this.map.get('zooms') as [number, number];\n    return zooms[1] - 1;\n  }\n  public setRotation(rotation: number): void {\n    return this.map.setRotation(rotation);\n  }\n\n  public zoomIn(): void {\n    this.map.zoomIn();\n  }\n\n  public zoomOut(): void {\n    this.map.zoomOut();\n  }\n\n  public panTo(p: [number, number]): void {\n    this.map.panTo(p);\n  }\n  public panBy(pixel: [number, number]): void {\n    this.map.panTo(pixel);\n  }\n  public fitBounds(extent: Bounds): void {\n    this.map.setBounds(\n      new AMap.Bounds([extent[0][0], extent[0][1], extent[1][0], extent[1][1]]),\n    );\n  }\n  public setZoomAndCenter(zoom: number, center: [number, number]): void {\n    this.map.setZoomAndCenter(zoom, center);\n  }\n  public setMapStyle(style: string): void {\n    this.map.setMapStyle(this.getMapStyle(style));\n  }\n  public pixelToLngLat(pixel: [number, number]): ILngLat {\n    const lngLat = this.map.pixelToLngLat(new AMap.Pixel(pixel[0], pixel[1]));\n    return { lng: lngLat.getLng(), lat: lngLat.getLat() };\n  }\n  public lngLatToPixel(lnglat: [number, number]): IPoint {\n    const p = this.map.lnglatToPixel(new AMap.LngLat(lnglat[0], lnglat[1]));\n    return {\n      x: p.getX(),\n      y: p.getY(),\n    };\n  }\n  public containerToLngLat(pixel: [number, number]): ILngLat {\n    const ll = new AMap.Pixel(pixel[0], pixel[1]);\n    const lngLat = this.map.containerToLngLat(ll);\n    return {\n      lng: lngLat?.getLng(),\n      lat: lngLat?.getLat(),\n    };\n  }\n  public lngLatToContainer(lnglat: [number, number]): IPoint {\n    const ll = new AMap.LngLat(lnglat[0], lnglat[1]);\n    const pixel = this.map.lngLatToContainer(ll);\n    return {\n      x: pixel.getX(),\n      y: pixel.getY(),\n    };\n  }\n\n  public async init(): Promise<void> {\n    const {\n      id,\n      style = 'light',\n      minZoom = 0,\n      maxZoom = 18,\n      token = AMAP_API_KEY,\n      mapInstance,\n      plugin = [],\n      ...rest\n    } = this.config;\n    // 高德地图创建独立的container；\n    // tslint:disable-next-line:typedef\n    await new Promise((resolve) => {\n      const resolveMap = () => {\n        if (mapInstance) {\n          this.map = mapInstance as AMap.Map & IAMapInstance;\n          this.$mapContainer = this.map.getContainer();\n          setTimeout(() => {\n            this.map.on('camerachange', this.handleCameraChanged);\n            resolve();\n          }, 30);\n        } else {\n          this.$mapContainer = this.creatAmapContainer(\n            id as string | HTMLDivElement,\n          );\n\n          const map = new AMap.Map(this.$mapContainer, {\n            mapStyle: this.getMapStyle(style as string),\n            zooms: [minZoom, maxZoom],\n            viewMode: '3D',\n            ...rest,\n          });\n          // 监听地图相机事件\n          map.on('camerachange', this.handleCameraChanged);\n          // @ts-ignore\n          this.map = map;\n          setTimeout(() => {\n            resolve();\n          }, 10);\n        }\n      };\n      if (!amapLoaded && !mapInstance) {\n        if (token === AMAP_API_KEY) {\n          this.logger.warn(this.configService.getSceneWarninfo('MapToken'));\n        }\n        amapLoaded = true;\n        this.loadAMapScript(\n          `https://webapi.amap.com/maps?v=${AMAP_VERSION}&key=${token}&plugin=Map3D${plugin.join(\n            ',',\n          )}`,\n        ).then(() => {\n          resolveMap();\n          if (pendingResolveQueue.length) {\n            pendingResolveQueue.forEach((r) => r());\n            pendingResolveQueue = [];\n          }\n        });\n      } else {\n        if ((amapLoaded && window.AMap) || mapInstance) {\n          resolveMap();\n        } else {\n          pendingResolveQueue.push(resolveMap);\n        }\n      }\n    });\n\n    this.viewport = new Viewport();\n  }\n  public emit(name: string, ...args: any[]) {\n    this.eventEmitter.emit(name, ...args);\n  }\n\n  public once(name: string, ...args: any[]) {\n    this.eventEmitter.once(name, ...args);\n  }\n\n  public destroy() {\n    this.map.destroy();\n    // @ts-ignore\n    delete window.initAMap;\n    const $jsapi = document.getElementById(AMAP_SCRIPT_ID);\n    if ($jsapi) {\n      document.head.removeChild($jsapi);\n    }\n  }\n\n  public getMapContainer() {\n    return this.$mapContainer;\n  }\n\n  public onCameraChanged(callback: (viewport: IViewport) => void): void {\n    this.cameraChangedCallback = callback;\n  }\n\n  private handleCameraChanged = (e: IAMapEvent): void => {\n    const {\n      fov,\n      near,\n      far,\n      height,\n      pitch,\n      rotation,\n      aspect,\n      position,\n    } = e.camera;\n    const { lng, lat } = this.getCenter();\n    if (this.cameraChangedCallback) {\n      // resync viewport\n      this.viewport.syncWithMapCamera({\n        aspect,\n        // AMap 定义 rotation 为顺时针方向，而 Mapbox 为逆时针\n        // @see https://docs.mapbox.com/mapbox-gl-js/api/#map#getbearing\n        bearing: 360 - rotation,\n        far,\n        fov,\n        cameraHeight: height,\n        near,\n        pitch,\n        // AMap 定义的缩放等级 与 Mapbox 相差 1\n        zoom: this.map.getZoom() - 1,\n        center: [lng, lat],\n        offsetOrigin: [position.x, position.y],\n      });\n\n      // set coordinate system\n      if (this.viewport.getZoom() > LNGLAT_OFFSET_ZOOM_THRESHOLD) {\n        this.coordinateSystemService.setCoordinateSystem(\n          CoordinateSystem.P20_OFFSET,\n        );\n      } else {\n        this.coordinateSystemService.setCoordinateSystem(CoordinateSystem.P20);\n      }\n      this.cameraChangedCallback(this.viewport);\n    }\n  };\n\n  private getMapStyle(name: string): string {\n    return MapTheme[name] ? MapTheme[name] : name;\n  }\n  private creatAmapContainer(id: string | HTMLDivElement) {\n    let $wrapper = id as HTMLDivElement;\n    if (typeof id === 'string') {\n      $wrapper = document.getElementById(id) as HTMLDivElement;\n    }\n    const $amapdiv = document.createElement('div');\n    $amapdiv.style.cssText += `\n      position: absolute;\n      top: 0;\n      height: 100%;\n      width: 100%;\n    `;\n    $amapdiv.id = 'l7_amap_div' + mapdivCount++;\n    $wrapper.appendChild($amapdiv);\n    return $amapdiv;\n  }\n  private loadAMapScript(src: string) {\n    return new Promise((resolve, reject) => {\n      const script = document.createElement('script');\n      script.src = src;\n      script.onload = () => {\n        resolve();\n      };\n      script.onerror = reject;\n      document.head.appendChild(script);\n    });\n  }\n}\n"],"file":"index.js"}