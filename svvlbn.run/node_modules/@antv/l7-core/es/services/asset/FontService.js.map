{"version":3,"sources":["../../../src/services/asset/FontService.ts"],"names":["LRUCache","TinySDF","injectable","buildMapping","DEFAULT_CHAR_SET","getDefaultCharacterSet","DEFAULT_FONT_FAMILY","DEFAULT_FONT_WEIGHT","DEFAULT_FONT_SIZE","DEFAULT_BUFFER","DEFAULT_CUTOFF","DEFAULT_RADIUS","MAX_CANVAS_WIDTH","BASELINE_SCALE","HEIGHT_SCALE","CACHE_LIMIT","VALID_PROPS","charSet","i","push","String","fromCharCode","setTextStyle","ctx","fontFamily","fontSize","fontWeight","font","fillStyle","textBaseline","populateAlphaChannel","alphaChannel","imageData","length","data","FontService","fontAtlas","fontOptions","key","cache","clear","characterSet","buffer","sdf","cutoff","radius","option","getKey","getNewChars","cachedFontAtlas","get","generateFontAtlas","set","canvas","document","createElement","width","getContext","getFontWidth","char","measureText","fontHeight","maxCanvasWidth","mapping","xOffset","yOffset","canvasHeight","height","getImageData","putImageData","tinySDF","size","draw","x","y","fillText","newChars","cachedMapping","cachedCharSet","Set","Object","keys","forEach","has"],"mappings":"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","sourcesContent":["import { LRUCache } from '@antv/l7-utils';\n// @ts-ignore\nimport TinySDF from '@mapbox/tiny-sdf';\nimport { inject, injectable } from 'inversify';\nimport { buildMapping } from '../../utils/font_util';\nimport {\n  IFontAtlas,\n  IFontMapping,\n  IFontMappingItem,\n  IFontOptions,\n  IFontService,\n} from './IFontService';\nexport const DEFAULT_CHAR_SET = getDefaultCharacterSet();\nexport const DEFAULT_FONT_FAMILY = 'sans-serif';\nexport const DEFAULT_FONT_WEIGHT = '800';\nexport const DEFAULT_FONT_SIZE = 24;\nexport const DEFAULT_BUFFER = 3;\nexport const DEFAULT_CUTOFF = 0.25;\nexport const DEFAULT_RADIUS = 8;\nconst MAX_CANVAS_WIDTH = 1024;\nconst BASELINE_SCALE = 1.0;\nconst HEIGHT_SCALE = 1.0;\nconst CACHE_LIMIT = 3;\nconst VALID_PROPS = [\n  'fontFamily',\n  'fontWeight',\n  'characterSet',\n  'fontSize',\n  'sdf',\n  'buffer',\n  'cutoff',\n  'radius',\n];\nfunction getDefaultCharacterSet() {\n  const charSet = [];\n  for (let i = 32; i < 128; i++) {\n    charSet.push(String.fromCharCode(i));\n  }\n  return charSet;\n}\n\nfunction setTextStyle(\n  ctx: CanvasRenderingContext2D,\n  fontFamily: string,\n  fontSize: number,\n  fontWeight: string,\n) {\n  ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;\n  ctx.fillStyle = 'black';\n  ctx.textBaseline = 'middle';\n  // ctx.textAlign = 'left';\n}\nfunction populateAlphaChannel(alphaChannel: number[], imageData: ImageData) {\n  // populate distance value from tinySDF to image alpha channel\n  for (let i = 0; i < alphaChannel.length; i++) {\n    imageData.data[4 * i + 3] = alphaChannel[i];\n  }\n}\n\n@injectable()\nexport default class FontService implements IFontService {\n  public fontAtlas: IFontAtlas;\n  private fontOptions: IFontOptions;\n  private key: string;\n  private cache: LRUCache = new LRUCache(CACHE_LIMIT);\n  public init() {\n    this.cache.clear();\n    this.fontOptions = {\n      fontFamily: DEFAULT_FONT_FAMILY,\n      fontWeight: DEFAULT_FONT_WEIGHT,\n      characterSet: DEFAULT_CHAR_SET,\n      fontSize: DEFAULT_FONT_SIZE,\n      buffer: DEFAULT_BUFFER,\n      sdf: true,\n      cutoff: DEFAULT_CUTOFF,\n      radius: DEFAULT_RADIUS,\n    };\n    this.key = '';\n  }\n\n  public get scale() {\n    return HEIGHT_SCALE;\n  }\n\n  public get canvas(): HTMLCanvasElement {\n    const data = this.cache.get(this.key);\n    return data && data.data;\n  }\n\n  public get mapping(): IFontMapping {\n    const data = this.cache.get(this.key);\n    return data && data.mapping;\n  }\n\n  public setFontOptions(option: Partial<IFontOptions>) {\n    this.fontOptions = {\n      ...this.fontOptions,\n      ...option,\n    };\n\n    // const oldKey = this.key;\n    this.key = this.getKey();\n\n    const charSet = this.getNewChars(this.key, this.fontOptions.characterSet);\n    const cachedFontAtlas = this.cache.get(this.key);\n\n    if (cachedFontAtlas && charSet.length === 0) {\n      // update texture with cached fontAtlas\n      return;\n    }\n    // update fontAtlas with new settings\n    const fontAtlas = this.generateFontAtlas(\n      this.key,\n      charSet,\n      cachedFontAtlas,\n    );\n    this.fontAtlas = fontAtlas;\n\n    // update cache\n    this.cache.set(this.key, fontAtlas);\n  }\n\n  public destroy(): void {\n    this.cache.clear();\n  }\n\n  private generateFontAtlas(\n    key: string,\n    characterSet: string[],\n    cachedFontAtlas: IFontAtlas,\n  ): IFontAtlas {\n    const {\n      fontFamily,\n      fontWeight,\n      fontSize,\n      buffer,\n      sdf,\n      radius,\n      cutoff,\n    } = this.fontOptions;\n    let canvas = cachedFontAtlas && cachedFontAtlas.data;\n    if (!canvas) {\n      canvas = document.createElement('canvas');\n      canvas.width = MAX_CANVAS_WIDTH;\n    }\n    const ctx = canvas.getContext('2d') as CanvasRenderingContext2D;\n    setTextStyle(ctx, fontFamily, fontSize, fontWeight);\n\n    // 1. build mapping\n    const { mapping, canvasHeight, xOffset, yOffset } = buildMapping({\n      getFontWidth: (char) => ctx.measureText(char).width,\n      fontHeight: fontSize * HEIGHT_SCALE,\n      buffer,\n      characterSet,\n      maxCanvasWidth: MAX_CANVAS_WIDTH,\n      ...(cachedFontAtlas && {\n        mapping: cachedFontAtlas.mapping,\n        xOffset: cachedFontAtlas.xOffset,\n        yOffset: cachedFontAtlas.yOffset,\n      }),\n    });\n\n    // 2. update canvas\n    // copy old canvas data to new canvas only when height changed\n    if (canvas.height !== canvasHeight) {\n      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n      canvas.height = canvasHeight;\n      ctx.putImageData(imageData, 0, 0);\n    }\n    setTextStyle(ctx, fontFamily, fontSize, fontWeight);\n\n    // 3. layout characters\n    if (sdf) {\n      const tinySDF = new TinySDF(\n        fontSize,\n        buffer,\n        radius,\n        cutoff,\n        fontFamily,\n        fontWeight,\n      );\n      // used to store distance values from tinySDF\n      // tinySDF.size equals `fontSize + buffer * 2`\n      const imageData = ctx.getImageData(0, 0, tinySDF.size, tinySDF.size);\n\n      for (const char of characterSet) {\n        populateAlphaChannel(tinySDF.draw(char), imageData);\n        // 考虑到描边，需要保留 sdf 的 buffer，不能像 deck.gl 一样直接减去\n        ctx.putImageData(imageData, mapping[char].x, mapping[char].y);\n      }\n    } else {\n      for (const char of characterSet) {\n        ctx.fillText(\n          char,\n          mapping[char].x,\n          mapping[char].y + fontSize * BASELINE_SCALE,\n        );\n      }\n    }\n    return {\n      xOffset,\n      yOffset,\n      mapping,\n      data: canvas,\n      width: canvas.width,\n      height: canvas.height,\n    };\n  }\n\n  private getKey() {\n    const {\n      fontFamily,\n      fontWeight,\n      fontSize,\n      buffer,\n      sdf,\n      radius,\n      cutoff,\n    } = this.fontOptions;\n    if (sdf) {\n      return `${fontFamily} ${fontWeight} ${fontSize} ${buffer} ${radius} ${cutoff}`;\n    }\n    return `${fontFamily} ${fontWeight} ${fontSize} ${buffer}`;\n  }\n\n  private getNewChars(key: string, characterSet: string[]): string[] {\n    const cachedFontAtlas = this.cache.get(key);\n    if (!cachedFontAtlas) {\n      return characterSet;\n    }\n\n    const newChars: string[] = [];\n    const cachedMapping = cachedFontAtlas.mapping;\n    const cachedCharSet = new Set(Object.keys(cachedMapping));\n    const charSet = new Set(characterSet);\n    charSet.forEach((char: string) => {\n      if (!cachedCharSet.has(char)) {\n        newChars.push(char);\n      }\n    });\n\n    return newChars;\n  }\n}\n"],"file":"FontService.js"}