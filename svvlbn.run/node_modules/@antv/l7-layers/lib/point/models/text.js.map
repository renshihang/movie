{"version":3,"sources":["../../../src/point/models/text.ts"],"names":["TextTriangulation","feature","centroid","glyphQuads","vertices","indices","coord","length","forEach","quad","index","push","tex","x","y","height","tl","width","tr","br","bl","size","TextModel","texture","glyphInfo","currentZoom","extent","layer","getLayerConfig","fontWeight","fontFamily","stroke","strokeWidth","canvas","fontService","u_opacity","u_sdf_map","u_stroke","u_halo_blur","u_sdf_map_size","u_strokeWidth","textExtent","initGlyph","updateTexture","filterGlyphs","buildLayerModel","moduleName","vertexShader","textVert","fragmentShader","textFrag","triangulation","depth","enable","blend","getBlend","textAllowOverlap","zoom","mapService","getZoom","getBounds","flag","Math","abs","models","styleAttributeService","registerStyleAttribute","name","type","AttributeType","Attribute","descriptor","buffer","usage","gl","STATIC_DRAW","data","FLOAT","update","featureIdx","vertex","attributeIdx","DYNAMIC_DRAW","Array","isArray","bounds","step","min","getEncodedData","characterSet","item","shape","toString","char","indexOf","setFontOptions","mapping","spacing","textAnchor","textOffset","map","coordinates","shaping","padding","rendererService","getViewportSize","collisionIndex","CollisionIndex","filterData","filter","id","fontScale","pixels","lngLatToContainer","placeCollisionBox","x1","left","x2","right","y1","top","y2","bottom","anchorPointX","anchorPointY","box","insertCollisionBox","setEncodedData","initTextFont","generateGlyphLayout","createTexture2D","BaseModel"],"mappings":"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","sourcesContent":["import {\n  AttributeType,\n  BlendType,\n  gl,\n  IEncodeFeature,\n  ILayer,\n  ILayerConfig,\n  IModel,\n  IModelUniform,\n  ITexture2D,\n} from '@antv/l7-core';\nimport { rgb2arr } from '@antv/l7-utils';\nimport BaseModel from '../../core/BaseModel';\nimport CollisionIndex from '../../utils/collision-index';\nimport { calculteCentroid } from '../../utils/geo';\nimport {\n  getGlyphQuads,\n  IGlyphQuad,\n  shapeText,\n} from '../../utils/symbol-layout';\nimport textFrag from '../shaders/text_frag.glsl';\nimport textVert from '../shaders/text_vert.glsl';\ninterface IPointTextLayerStyleOptions {\n  opacity: number;\n  textAnchor: string;\n  spacing: number;\n  padding: [number, number];\n  stroke: string;\n  strokeWidth: number;\n  strokeOpacity: number;\n  fontWeight: string;\n  fontFamily: string;\n  textOffset: [number, number];\n  textAllowOverlap: boolean;\n}\nexport function TextTriangulation(feature: IEncodeFeature) {\n  const centroid = feature.centroid as number[]; // 计算中心点\n  const { glyphQuads } = feature;\n  const vertices: number[] = [];\n  const indices: number[] = [];\n  const coord =\n    centroid.length === 2 ? [centroid[0], centroid[1], 0] : centroid;\n  glyphQuads.forEach((quad: IGlyphQuad, index: number) => {\n    vertices.push(\n      ...coord,\n      quad.tex.x,\n      quad.tex.y + quad.tex.height,\n      quad.tl.x,\n      quad.tl.y,\n      ...coord,\n      quad.tex.x + quad.tex.width,\n      quad.tex.y + quad.tex.height,\n      quad.tr.x,\n      quad.tr.y,\n      ...coord,\n      quad.tex.x + quad.tex.width,\n      quad.tex.y,\n      quad.br.x,\n      quad.br.y,\n      ...coord,\n      quad.tex.x,\n      quad.tex.y,\n      quad.bl.x,\n      quad.bl.y,\n    );\n    indices.push(\n      0 + index * 4,\n      1 + index * 4,\n      2 + index * 4,\n      2 + index * 4,\n      3 + index * 4,\n      0 + index * 4,\n    );\n  });\n  return {\n    vertices, // [ x, y, z, tex.x,tex.y, offset.x. offset.y]\n    indices,\n    size: 7,\n  };\n}\n\nexport default class TextModel extends BaseModel {\n  private texture: ITexture2D;\n  private glyphInfo: IEncodeFeature[];\n  private currentZoom: number = -1;\n  private extent: [[number, number], [number, number]];\n\n  public getUninforms(): IModelUniform {\n    const {\n      fontWeight = 800,\n      fontFamily = 'sans-serif',\n      stroke = '#fff',\n      strokeWidth = 0,\n    } = this.layer.getLayerConfig() as IPointTextLayerStyleOptions;\n    const { canvas } = this.fontService;\n    return {\n      u_opacity: 1.0,\n      u_sdf_map: this.texture,\n      u_stroke: rgb2arr(stroke),\n      u_halo_blur: 0.5,\n      u_sdf_map_size: [canvas.width, canvas.height],\n      u_strokeWidth: strokeWidth,\n    };\n  }\n\n  public buildModels(): IModel[] {\n    this.extent = this.textExtent();\n    this.initGlyph();\n    this.updateTexture();\n    this.filterGlyphs();\n    return [\n      this.layer.buildLayerModel({\n        moduleName: 'pointText',\n        vertexShader: textVert,\n        fragmentShader: textFrag,\n        triangulation: TextTriangulation,\n        depth: { enable: false },\n        blend: this.getBlend(),\n      }),\n    ];\n  }\n  public needUpdate() {\n    const {\n      textAllowOverlap = false,\n    } = this.layer.getLayerConfig() as IPointTextLayerStyleOptions;\n    const zoom = this.mapService.getZoom();\n    const extent = this.mapService.getBounds();\n    const flag =\n      extent[0][0] < this.extent[0][0] ||\n      extent[0][1] < this.extent[0][1] ||\n      extent[1][0] > this.extent[1][0] ||\n      extent[1][1] < this.extent[1][1];\n\n    if (!textAllowOverlap && (Math.abs(this.currentZoom - zoom) > 1 || flag)) {\n      this.filterGlyphs();\n      this.layer.models = [\n        this.layer.buildLayerModel({\n          moduleName: 'pointText',\n          vertexShader: textVert,\n          fragmentShader: textFrag,\n          triangulation: TextTriangulation,\n          depth: { enable: false },\n          blend: this.getBlend(),\n        }),\n      ];\n      return true;\n    }\n    return false;\n  }\n\n  protected registerBuiltinAttributes() {\n    this.styleAttributeService.registerStyleAttribute({\n      name: 'textOffsets',\n      type: AttributeType.Attribute,\n      descriptor: {\n        name: 'a_textOffsets',\n        buffer: {\n          // give the WebGL driver a hint that this buffer may change\n          usage: gl.STATIC_DRAW,\n          data: [],\n          type: gl.FLOAT,\n        },\n        size: 2,\n        update: (\n          feature: IEncodeFeature,\n          featureIdx: number,\n          vertex: number[],\n          attributeIdx: number,\n        ) => {\n          return [vertex[5], vertex[6]];\n        },\n      },\n    });\n\n    // point layer size;\n    this.styleAttributeService.registerStyleAttribute({\n      name: 'size',\n      type: AttributeType.Attribute,\n      descriptor: {\n        name: 'a_Size',\n        buffer: {\n          // give the WebGL driver a hint that this buffer may change\n          usage: gl.DYNAMIC_DRAW,\n          data: [],\n          type: gl.FLOAT,\n        },\n        size: 1,\n        update: (\n          feature: IEncodeFeature,\n          featureIdx: number,\n          vertex: number[],\n          attributeIdx: number,\n        ) => {\n          const { size } = feature;\n          return Array.isArray(size) ? [size[0]] : [size as number];\n        },\n      },\n    });\n\n    // point layer size;\n    this.styleAttributeService.registerStyleAttribute({\n      name: 'textUv',\n      type: AttributeType.Attribute,\n      descriptor: {\n        name: 'a_tex',\n        buffer: {\n          // give the WebGL driver a hint that this buffer may change\n          usage: gl.DYNAMIC_DRAW,\n          data: [],\n          type: gl.FLOAT,\n        },\n        size: 2,\n        update: (\n          feature: IEncodeFeature,\n          featureIdx: number,\n          vertex: number[],\n          attributeIdx: number,\n        ) => {\n          return [vertex[3], vertex[4]];\n        },\n      },\n    });\n  }\n  private textExtent(): [[number, number], [number, number]] {\n    const bounds = this.mapService.getBounds();\n    const step =\n      Math.min(bounds[1][0] - bounds[0][0], bounds[1][1] - bounds[1][0]) / 2;\n    return [\n      [bounds[0][0] - step, bounds[0][1] - step],\n      [bounds[1][0] + step, bounds[1][1] + step],\n    ];\n  }\n  /**\n   * 生成文字纹理\n   */\n  private initTextFont() {\n    const {\n      fontWeight = '800',\n      fontFamily,\n    } = this.layer.getLayerConfig() as IPointTextLayerStyleOptions;\n    const data = this.layer.getEncodedData();\n    const characterSet: string[] = [];\n    data.forEach((item: IEncodeFeature) => {\n      let { shape = '' } = item;\n      shape = shape.toString();\n      for (const char of shape) {\n        // 去重\n        if (characterSet.indexOf(char) === -1) {\n          characterSet.push(char);\n        }\n      }\n    });\n    this.fontService.setFontOptions({\n      characterSet,\n      fontWeight,\n      fontFamily,\n    });\n  }\n  /**\n   * 生成文字布局\n   */\n  private generateGlyphLayout() {\n    const { mapping } = this.fontService;\n    const {\n      spacing = 2,\n      textAnchor = 'center',\n      textOffset,\n    } = this.layer.getLayerConfig() as IPointTextLayerStyleOptions;\n    const data = this.layer.getEncodedData();\n    this.glyphInfo = data.map((feature: IEncodeFeature) => {\n      const { shape = '', coordinates } = feature;\n      const shaping = shapeText(\n        shape.toString(),\n        mapping,\n        24,\n        textAnchor,\n        'center',\n        spacing,\n        textOffset,\n      );\n      const glyphQuads = getGlyphQuads(shaping, textOffset, false);\n      feature.shaping = shaping;\n      feature.glyphQuads = glyphQuads;\n      feature.centroid = calculteCentroid(coordinates);\n      return feature;\n    });\n  }\n  /**\n   * 文字避让\n   */\n  private filterGlyphs() {\n    const {\n      padding = [4, 4],\n      textAllowOverlap = false,\n    } = this.layer.getLayerConfig() as IPointTextLayerStyleOptions;\n    if (textAllowOverlap) {\n      return;\n    }\n    this.currentZoom = this.mapService.getZoom();\n    this.extent = this.textExtent();\n    const { width, height } = this.rendererService.getViewportSize();\n    const collisionIndex = new CollisionIndex(width, height);\n    const filterData = this.glyphInfo.filter((feature: IEncodeFeature) => {\n      const { shaping, id = 0 } = feature;\n      const centroid = feature.centroid as [number, number];\n      const size = feature.size as number;\n      const fontScale: number = size / 24;\n      const pixels = this.mapService.lngLatToContainer(centroid);\n      const { box } = collisionIndex.placeCollisionBox({\n        x1: shaping.left * fontScale - padding[0],\n        x2: shaping.right * fontScale + padding[0],\n        y1: shaping.top * fontScale - padding[1],\n        y2: shaping.bottom * fontScale + padding[1],\n        anchorPointX: pixels.x,\n        anchorPointY: pixels.y,\n      });\n      if (box && box.length) {\n        // TODO：featureIndex\n        collisionIndex.insertCollisionBox(box, id);\n        return true;\n      } else {\n        return false;\n      }\n    });\n    this.layer.setEncodedData(filterData);\n  }\n  /**\n   * 初始化文字布局\n   */\n  private initGlyph() {\n    // 1.生成文字纹理\n    this.initTextFont();\n    // 2.生成文字布局\n    this.generateGlyphLayout();\n  }\n  /**\n   * 更新文字纹理\n   */\n  private updateTexture() {\n    const { createTexture2D } = this.rendererService;\n    const { canvas } = this.fontService;\n    this.texture = createTexture2D({\n      data: canvas,\n      width: canvas.width,\n      height: canvas.height,\n    });\n  }\n}\n"],"file":"text.js"}