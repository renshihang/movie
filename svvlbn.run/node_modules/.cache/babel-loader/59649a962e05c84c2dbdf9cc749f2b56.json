{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _isNil from \"lodash/isNil\";\n\nvar StyleAttribute = function () {\n  function StyleAttribute(options) {\n    var _this = this;\n\n    _classCallCheck(this, StyleAttribute);\n\n    this.name = void 0;\n    this.type = void 0;\n    this.scale = void 0;\n    this.descriptor = void 0;\n    this.featureBufferLayout = [];\n    this.needRescale = false;\n    this.needRemapping = false;\n    this.needRegenerateVertices = false;\n    this.featureRange = {\n      startIndex: 0,\n      endIndex: Infinity\n    };\n    this.vertexAttribute = void 0;\n\n    this.defaultCallback = function (params) {\n      if (params.length === 0) {\n        var _this$scale;\n\n        return ((_this$scale = _this.scale) === null || _this$scale === void 0 ? void 0 : _this$scale.values) || [];\n      }\n\n      return params.map(function (param, idx) {\n        var _this$scale2;\n\n        var scaleFunc = ((_this$scale2 = _this.scale) === null || _this$scale2 === void 0 ? void 0 : _this$scale2.scalers)[idx].func;\n        var value = scaleFunc(param);\n        return value;\n      });\n    };\n\n    this.setProps(options);\n  }\n\n  _createClass(StyleAttribute, [{\n    key: \"setProps\",\n    value: function setProps(options) {\n      Object.assign(this, options);\n    }\n  }, {\n    key: \"mapping\",\n    value: function mapping(params) {\n      var _this$scale3;\n\n      if ((_this$scale3 = this.scale) === null || _this$scale3 === void 0 ? void 0 : _this$scale3.callback) {\n        var _this$scale4;\n\n        var ret = (_this$scale4 = this.scale) === null || _this$scale4 === void 0 ? void 0 : _this$scale4.callback(params);\n\n        if (!_isNil(ret)) {\n          return [ret];\n        }\n      }\n\n      return this.defaultCallback(params);\n    }\n  }, {\n    key: \"resetDescriptor\",\n    value: function resetDescriptor() {\n      if (this.descriptor) {\n        this.descriptor.buffer.data = [];\n      }\n    }\n  }]);\n\n  return StyleAttribute;\n}();\n\nexport { StyleAttribute as default };","map":{"version":3,"sources":["../../../src/services/layer/StyleAttribute.ts"],"names":["StyleAttribute","name","type","scale","descriptor","featureBufferLayout","needRescale","needRemapping","needRegenerateVertices","featureRange","startIndex","endIndex","Infinity","vertexAttribute","options","Object","params","ret","scaleFunc","value"],"mappings":";;;;IAeqBA,c;AA+BnB,WAAA,cAAA,CAAA,OAAA,EAAoE;AAAA,QAAA,KAAA,GAAA,IAAA;;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,cAAA,CAAA;;AAAA,SA9B7DC,IA8B6D,GAAA,KAAA,CAAA;AAAA,SA7B7DC,IA6B6D,GAAA,KAAA,CAAA;AAAA,SA5B7DC,KA4B6D,GAAA,KAAA,CAAA;AAAA,SAjB7DC,UAiB6D,GAAA,KAAA,CAAA;AAAA,SAhB7DC,mBAgB6D,GAX/D,EAW+D;AAAA,SAT7DC,WAS6D,GATtC,KASsC;AAAA,SAR7DC,aAQ6D,GARpC,KAQoC;AAAA,SAP7DC,sBAO6D,GAP3B,KAO2B;AAAA,SAN7DC,YAM6D,GAN/B;AACnCC,MAAAA,UAAU,EADyB,CAAA;AAEnCC,MAAAA,QAAQ,EAAEC;AAFyB,KAM+B;AAAA,SAF7DC,eAE6D,GAAA,KAAA,CAAA;;AAAA,SAAA,eAAA,GA8B1C,UAAA,MAAA,EAAkC;AAE1D,UAAIG,MAAM,CAANA,MAAAA,KAAJ,CAAA,EAAyB;AAAA,YAAA,WAAA;;AACvB,eAAO,CAAA,CAAA,WAAA,GAAA,KAAI,CAAJ,KAAA,MAAA,IAAA,IAAA,WAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,WAAA,CAAA,MAAA,KAAP,EAAA;AACD;;AACD,aAAO,MAAM,CAAN,GAAA,CAAW,UAAA,KAAA,EAAA,GAAA,EAAgB;AAAA,YAAA,YAAA;;AAChC,YAAME,SAAS,GAAG,CAAA,CAAA,YAAA,GAAA,KAAI,CAAJ,KAAA,MAAA,IAAA,IAAA,YAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,YAAA,CAAA,OAAA,EAAA,GAAA,EAAlB,IAAA;AAEA,YAAMC,KAAK,GAAGD,SAAS,CAAvB,KAAuB,CAAvB;AACA,eAAA,KAAA;AAJF,OAAO,CAAP;AAnCkE,KAAA;;AAClE,SAAA,QAAA,CAAA,OAAA;AACD;;;;6BAEeJ,O,EAAwD;AACtEC,MAAAA,MAAM,CAANA,MAAAA,CAAAA,IAAAA,EAAAA,OAAAA;AACD;;;4BAEcC,M,EAA8B;AAAA,UAAA,YAAA;;AAI3C,UAAA,CAAA,YAAA,GAAI,KAAJ,KAAA,MAAA,IAAA,IAAA,YAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAI,YAAA,CAAJ,QAAA,EAA0B;AAAA,YAAA,YAAA;;AAExB,YAAMC,GAAG,GAAA,CAAA,YAAA,GAAG,KAAH,KAAA,MAAA,IAAA,IAAA,YAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAG,YAAA,CAAA,QAAA,CAAZ,MAAY,CAAZ;;AACA,YAAI,CAAC,MAAA,CAAL,GAAK,CAAL,EAAiB;AACf,iBAAO,CAAP,GAAO,CAAP;AACD;AACF;;AAGD,aAAO,KAAA,eAAA,CAAP,MAAO,CAAP;AACD;;;sCAEwB;AACvB,UAAI,KAAJ,UAAA,EAAqB;AACnB,aAAA,UAAA,CAAA,MAAA,CAAA,IAAA,GAAA,EAAA;AACD;AACF;;;;;;SA3DkBjB,c","sourcesContent":["import { isNil } from 'lodash';\nimport {\n  IStyleAttribute,\n  StyleScaleType,\n} from '../layer/IStyleAttributeService';\nimport { IAttribute } from '../renderer/IAttribute';\nimport {\n  AttributeType,\n  IEncodeFeature,\n  IFeatureRange,\n  IStyleAttributeInitializationOptions,\n  IStyleScale,\n  IVertexAttributeDescriptor,\n} from './IStyleAttributeService';\n\nexport default class StyleAttribute implements IStyleAttribute {\n  public name: string;\n  public type: AttributeType;\n  public scale?: {\n    type: StyleScaleType.CONSTANT;\n    names: string[];\n    field: string | string[];\n    values: unknown[];\n    callback?: (...args: any[]) => [];\n    scalers?: Array<{\n      field: string;\n      func: unknown;\n    }>;\n  };\n  public descriptor: IVertexAttributeDescriptor;\n  public featureBufferLayout: Array<{\n    feature: IEncodeFeature;\n    featureIdx: number;\n    bufferOffset: number;\n    length: number;\n  }> = [];\n\n  public needRescale: boolean = false;\n  public needRemapping: boolean = false;\n  public needRegenerateVertices: boolean = false;\n  public featureRange: IFeatureRange = {\n    startIndex: 0,\n    endIndex: Infinity,\n  };\n  public vertexAttribute: IAttribute;\n\n  constructor(options: Partial<IStyleAttributeInitializationOptions>) {\n    this.setProps(options);\n  }\n\n  public setProps(options: Partial<IStyleAttributeInitializationOptions>) {\n    Object.assign(this, options);\n  }\n\n  public mapping(params: unknown[]): unknown[] {\n    /**\n     * 当用户设置的 callback 返回 null 时, 应该返回默认 callback 中的值\n     */\n    if (this.scale?.callback) {\n      // 使用用户返回的值处理\n      const ret = this.scale?.callback(params);\n      if (!isNil(ret)) {\n        return [ret];\n      }\n    }\n\n    // 没有 callback 或者用户 callback 返回值为空，则使用默认的逻辑处理\n    return this.defaultCallback(params);\n  }\n\n  public resetDescriptor() {\n    if (this.descriptor) {\n      this.descriptor.buffer.data = [];\n    }\n  }\n\n  private defaultCallback = (params: unknown[]): unknown[] => {\n    // 没有 params 的情况，是指没有指定 fields，直接返回配置的 values 常量\n    if (params.length === 0) {\n      return this.scale?.values || [];\n    }\n    return params.map((param, idx) => {\n      const scaleFunc = this.scale?.scalers![idx].func;\n      // @ts-ignore\n      const value = scaleFunc(param);\n      return value;\n    });\n  };\n}\n"]},"metadata":{},"sourceType":"module"}