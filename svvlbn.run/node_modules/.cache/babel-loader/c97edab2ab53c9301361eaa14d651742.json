{"ast":null,"code":"import _slicedToArray from \"@babel/runtime/helpers/slicedToArray\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport { mat4, vec3 } from 'gl-matrix';\nvar DEGREES_TO_RADIANS = Math.PI / 180;\n\nvar Viewport = function () {\n  function Viewport() {\n    _classCallCheck(this, Viewport);\n\n    this.projectionMatrix = mat4.create();\n    this.viewMatrix = mat4.create();\n    this.viewProjectionMatrix = mat4.create();\n    this.viewUncenteredMatrix = mat4.create();\n    this.zoom = void 0;\n    this.center = void 0;\n  }\n\n  _createClass(Viewport, [{\n    key: \"syncWithMapCamera\",\n    value: function syncWithMapCamera(mapCamera) {\n      var _mapCamera$zoom = mapCamera.zoom,\n          zoom = _mapCamera$zoom === void 0 ? 1 : _mapCamera$zoom,\n          _mapCamera$pitch = mapCamera.pitch,\n          pitch = _mapCamera$pitch === void 0 ? 0 : _mapCamera$pitch,\n          _mapCamera$bearing = mapCamera.bearing,\n          bearing = _mapCamera$bearing === void 0 ? 0 : _mapCamera$bearing,\n          _mapCamera$center = mapCamera.center,\n          center = _mapCamera$center === void 0 ? [0, 0] : _mapCamera$center,\n          _mapCamera$offsetOrig = mapCamera.offsetOrigin,\n          offsetOrigin = _mapCamera$offsetOrig === void 0 ? [0, 0] : _mapCamera$offsetOrig,\n          _mapCamera$cameraHeig = mapCamera.cameraHeight,\n          cameraHeight = _mapCamera$cameraHeig === void 0 ? 1 : _mapCamera$cameraHeig,\n          _mapCamera$aspect = mapCamera.aspect,\n          aspect = _mapCamera$aspect === void 0 ? 1 : _mapCamera$aspect,\n          _mapCamera$near = mapCamera.near,\n          near = _mapCamera$near === void 0 ? 0.1 : _mapCamera$near,\n          _mapCamera$far = mapCamera.far,\n          far = _mapCamera$far === void 0 ? 1000 : _mapCamera$far,\n          _mapCamera$fov = mapCamera.fov,\n          fov = _mapCamera$fov === void 0 ? 0 : _mapCamera$fov;\n      this.zoom = zoom;\n      this.center = center;\n      var pitchInRadians = pitch * DEGREES_TO_RADIANS;\n      var rotationInRadians = (360 - bearing) * DEGREES_TO_RADIANS;\n      mat4.perspective(this.projectionMatrix, fov, aspect, near, far);\n      var eye = vec3.fromValues(cameraHeight * Math.sin(pitchInRadians) * Math.sin(rotationInRadians), -cameraHeight * Math.sin(pitchInRadians) * Math.cos(rotationInRadians), cameraHeight * Math.cos(pitchInRadians));\n      var up = vec3.fromValues(-Math.cos(pitchInRadians) * Math.sin(rotationInRadians), Math.cos(pitchInRadians) * Math.cos(rotationInRadians), Math.sin(pitchInRadians));\n      mat4.lookAt(this.viewMatrix, eye, vec3.fromValues(0, 0, 0), up);\n      this.viewUncenteredMatrix = mat4.clone(this.viewMatrix);\n      mat4.translate(this.viewMatrix, this.viewMatrix, vec3.fromValues(-offsetOrigin[0], offsetOrigin[1], 0));\n      mat4.multiply(this.viewProjectionMatrix, this.projectionMatrix, this.viewMatrix);\n    }\n  }, {\n    key: \"getZoom\",\n    value: function getZoom() {\n      return this.zoom;\n    }\n  }, {\n    key: \"getZoomScale\",\n    value: function getZoomScale() {\n      return 524288;\n    }\n  }, {\n    key: \"getCenter\",\n    value: function getCenter() {\n      var _this$center = _slicedToArray(this.center, 2),\n          lng = _this$center[0],\n          lat = _this$center[1];\n\n      return [lng, lat];\n    }\n  }, {\n    key: \"getProjectionMatrix\",\n    value: function getProjectionMatrix() {\n      return this.projectionMatrix;\n    }\n  }, {\n    key: \"getViewMatrix\",\n    value: function getViewMatrix() {\n      return this.viewMatrix;\n    }\n  }, {\n    key: \"getViewMatrixUncentered\",\n    value: function getViewMatrixUncentered() {\n      return this.viewUncenteredMatrix;\n    }\n  }, {\n    key: \"getViewProjectionMatrix\",\n    value: function getViewProjectionMatrix() {\n      return this.viewProjectionMatrix;\n    }\n  }, {\n    key: \"getFocalDistance\",\n    value: function getFocalDistance() {\n      return 1;\n    }\n  }, {\n    key: \"projectFlat\",\n    value: function projectFlat(lngLat, scale) {\n      var maxs = 85.0511287798;\n      var lat = Math.max(Math.min(maxs, lngLat[1]), -maxs);\n      var zoomScale = 256 << 20;\n      var d = Math.PI / 180;\n      var x = lngLat[0] * d;\n      var y = lat * d;\n      y = Math.log(Math.tan(Math.PI / 4 + y / 2));\n      var a = 0.5 / Math.PI;\n      var b = 0.5;\n      var c = -0.5 / Math.PI;\n      d = 0.5;\n      x = zoomScale * (a * x + b) - 215440491;\n      y = -(zoomScale * (c * y + d) - 106744817);\n      return [x, y];\n    }\n  }]);\n\n  return Viewport;\n}();\n\nexport { Viewport as default };","map":{"version":3,"sources":["../../src/amap/Viewport.ts"],"names":["DEGREES_TO_RADIANS","Math","Viewport","projectionMatrix","mat4","viewMatrix","viewProjectionMatrix","viewUncenteredMatrix","zoom","center","mapCamera","pitch","bearing","offsetOrigin","cameraHeight","aspect","near","far","fov","pitchInRadians","rotationInRadians","eye","vec3","up","lng","lat","lngLat","scale","maxs","zoomScale","d","x","y","a","b","c"],"mappings":"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","sourcesContent":["import { IMapCamera, IViewport } from '@antv/l7-core';\nimport { mat4, vec3 } from 'gl-matrix';\n\nconst DEGREES_TO_RADIANS = Math.PI / 180;\n\nexport default class Viewport implements IViewport {\n  private projectionMatrix: mat4 = mat4.create();\n  private viewMatrix: mat4 = mat4.create();\n  private viewProjectionMatrix: mat4 = mat4.create();\n  private viewUncenteredMatrix: mat4 = mat4.create();\n  private zoom: number;\n  private center: number[];\n\n  public syncWithMapCamera(mapCamera: Partial<IMapCamera>) {\n    const {\n      zoom = 1,\n      pitch = 0,\n      bearing = 0,\n      center = [0, 0],\n      offsetOrigin = [0, 0],\n      cameraHeight = 1,\n      aspect = 1,\n      near = 0.1,\n      far = 1000,\n      fov = 0,\n    } = mapCamera;\n    this.zoom = zoom;\n    this.center = center;\n\n    const pitchInRadians = pitch * DEGREES_TO_RADIANS;\n    const rotationInRadians = (360 - bearing) * DEGREES_TO_RADIANS;\n\n    // 计算透视投影矩阵 projectionMatrix\n    mat4.perspective(this.projectionMatrix, fov, aspect, near, far);\n\n    // 计算相机矩阵 viewMatrix\n    const eye = vec3.fromValues(\n      cameraHeight * Math.sin(pitchInRadians) * Math.sin(rotationInRadians),\n      -cameraHeight * Math.sin(pitchInRadians) * Math.cos(rotationInRadians),\n      cameraHeight * Math.cos(pitchInRadians),\n    );\n    const up = vec3.fromValues(\n      -Math.cos(pitchInRadians) * Math.sin(rotationInRadians),\n      Math.cos(pitchInRadians) * Math.cos(rotationInRadians),\n      Math.sin(pitchInRadians),\n    );\n    mat4.lookAt(this.viewMatrix, eye, vec3.fromValues(0, 0, 0), up);\n\n    this.viewUncenteredMatrix = mat4.clone(this.viewMatrix);\n\n    // 移动相机位置\n    mat4.translate(\n      this.viewMatrix,\n      this.viewMatrix,\n      vec3.fromValues(-offsetOrigin[0], offsetOrigin[1], 0),\n    );\n\n    mat4.multiply(\n      this.viewProjectionMatrix,\n      this.projectionMatrix,\n      this.viewMatrix,\n    );\n  }\n\n  public getZoom(): number {\n    return this.zoom;\n  }\n\n  public getZoomScale(): number {\n    // 512 尺寸下的缩放：2 ^ 19\n    return 524288;\n  }\n\n  public getCenter(): [number, number] {\n    const [lng, lat] = this.center;\n    return [lng, lat];\n  }\n\n  public getProjectionMatrix(): number[] {\n    // @ts-ignore\n    return this.projectionMatrix;\n  }\n\n  public getViewMatrix(): number[] {\n    // @ts-ignore\n    return this.viewMatrix;\n  }\n\n  public getViewMatrixUncentered(): number[] {\n    // @ts-ignore\n    return this.viewUncenteredMatrix;\n  }\n  public getViewProjectionMatrix(): number[] {\n    // @ts-ignore\n    return this.viewProjectionMatrix;\n  }\n\n  public getFocalDistance() {\n    return 1;\n  }\n\n  /**\n   * P20 坐标系，固定 scale\n   */\n  public projectFlat(\n    lngLat: [number, number],\n    scale?: number | undefined,\n  ): [number, number] {\n    const maxs = 85.0511287798;\n    const lat = Math.max(Math.min(maxs, lngLat[1]), -maxs);\n    // tslint:disable-next-line:no-bitwise\n    const zoomScale = 256 << 20;\n    let d = Math.PI / 180;\n    let x = lngLat[0] * d;\n    let y = lat * d;\n    y = Math.log(Math.tan(Math.PI / 4 + y / 2));\n    const a = 0.5 / Math.PI;\n    const b = 0.5;\n    const c = -0.5 / Math.PI;\n    d = 0.5;\n    x = zoomScale * (a * x + b) - 215440491;\n    y = -(zoomScale * (c * y + d) - 106744817);\n    return [x, y];\n  }\n}\n"]},"metadata":{},"sourceType":"module"}